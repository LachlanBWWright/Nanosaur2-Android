name: Deploy WebAssembly to GitHub Pages

on:
  push:
  workflow_dispatch:

# Required for OIDC-based Pages deployment
permissions:
  contents: read
  pages:    write
  id-token: write

# Serialise deployments; allow parallel non-deploy runs on other branches
concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
      - uses: actions/checkout@v4
        with: {submodules: 'recursive'}

      # Configure the GitHub Pages environment (sets base URL etc.)
      - name: Setup Pages
        if: github.ref == 'refs/heads/master'
        uses: actions/configure-pages@v5

      # Cache the Emscripten SDK to speed up builds
      - name: Cache Emscripten SDK
        id: cache-emsdk
        uses: actions/cache@v4
        with:
          path: .emsdk
          key: emsdk-${{ runner.os }}-${{ runner.arch }}-v1
          restore-keys: emsdk-${{ runner.os }}-${{ runner.arch }}-

      - name: Install Emscripten
        run: |
          if [ ! -f .emsdk/emsdk ]; then
            git clone --depth=1 https://github.com/emscripten-core/emsdk.git .emsdk
            .emsdk/emsdk install latest
          fi
          .emsdk/emsdk activate latest
          source .emsdk/emsdk_env.sh
          echo "EMSDK=$EMSDK" >> "$GITHUB_ENV"
          echo "EM_CONFIG=$EM_CONFIG" >> "$GITHUB_ENV"
          echo "EM_CACHE=$EM_CACHE" >> "$GITHUB_ENV"
          echo "$EMSDK" >> "$GITHUB_PATH"
          echo "$EMSDK/upstream/emscripten" >> "$GITHUB_PATH"
          echo "$EMSDK/upstream/bin" >> "$GITHUB_PATH"
          for d in "$EMSDK/node/"*/bin; do [ -d "$d" ] && echo "$d" >> "$GITHUB_PATH"; done

      # Build WebAssembly with Emscripten
      - name: Download SDL3 source
        run: python3 build.py --wasm --dependencies

      - name: Configure WASM build
        run: python3 build.py --wasm --configure

      - name: Build WASM
        run: python3 build.py --wasm --build

      # Assemble the GitHub Pages site in _site/ (master branch only)
      - name: Assemble site
        if: github.ref == 'refs/heads/master'
        run: |
          mkdir -p _site

          # Copy all static assets from docs/ (logo, screenshots, PDFs, etc.)
          # The shell.html is skipped — the built Nanosaur2.html (with our shell) is used instead.
          for f in docs/*; do
            case "$f" in
              docs/shell.html) ;;  # Skip — the built HTML (with our shell) is used instead
              *) cp -r "$f" _site/ 2>/dev/null || true ;;
            esac
          done

          # WASM build output — rename the HTML entrypoint to index.html
          cp build-wasm/Nanosaur2.html _site/index.html
          cp build-wasm/Nanosaur2.js   _site/Nanosaur2.js
          cp build-wasm/Nanosaur2.wasm _site/Nanosaur2.wasm

          # The .data file (preloaded game assets) may be very large;
          # copy it only if it exists (build might inline it instead)
          [ -f build-wasm/Nanosaur2.data ] && cp build-wasm/Nanosaur2.data _site/Nanosaur2.data || true

          # Prevent Jekyll from processing our static site files
          touch _site/.nojekyll

          echo "Site contents:"
          ls -lh _site/

      - name: Upload Pages artifact
        if: github.ref == 'refs/heads/master'
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site/

  # Deploy to GitHub Pages — only runs on master to avoid environment
  # protection conflicts on non-master branches.
  deploy:
    needs: build
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-22.04
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
